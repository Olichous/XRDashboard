<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XR Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container my-4">
    <h1>XR Dashboard</h1>
    <ul class="nav nav-tabs" id="tabMenu">
        <li class="nav-item">
            <a class="nav-link active" href="#inventory" data-bs-toggle="tab">Inventory</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#upload" data-bs-toggle="tab">Upload Images</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#update" data-bs-toggle="tab">Update</a>
        </li>
    </ul>
    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="inventory">
            <button id="addBtn" class="btn btn-primary mb-2">+</button>
            <table class="table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Hostname</th>
                        <th>Model</th>
                        <th>Version</th>
                        <th>Mgmt IP</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="tab-pane fade" id="upload">
            <form id="uploadForm">
                <input type="file" name="file" id="fileInput">
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
            <div id="uploadMsg" class="mt-2"></div>
        </div>
        <div class="tab-pane fade" id="update">
            <p>Select a device to update</p>
            <select id="deviceSelect" class="form-select"></select>
            <button id="updateBtn" class="btn btn-warning mt-2">Update</button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showToast(message, type = "success") {
    const uploadMsg = document.getElementById('uploadMsg');
    uploadMsg.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}

function loadInventory(){
    axios.get('/api/equipment').then(res=>{
        const tbody=document.querySelector('#inventoryTable tbody');
        tbody.innerHTML='';
        res.data.forEach(eq=>{
            const tr=document.createElement('tr');
            const status=document.createElement('td');
            status.innerHTML=`<span class='badge rounded-pill ${eq.status ? 'bg-success' : 'bg-danger'}'>&nbsp;</span>`;
            tr.appendChild(status);
            tr.innerHTML+=`<td>${eq.hostname}</td><td>${eq.model}</td><td>${eq.version}</td><td>${eq.mgmt_ip}</td>`;
            tbody.appendChild(tr);
        });
    });
}

function loadDevicesToSelect(){
    axios.get('/api/equipment').then(res=>{
        const select=document.getElementById('deviceSelect');
        select.innerHTML='';
        res.data.forEach(eq=>{
            const opt=document.createElement('option');
            opt.value=eq.id; opt.text=eq.hostname;
            select.appendChild(opt);
        });
    });
}

document.getElementById('addBtn').addEventListener('click',()=>{
    const ip=prompt('Management IP?');
    if(ip){
        axios.post('/api/equipment', {mgmt_ip: ip})
            .then(()=>{
                loadInventory();
                loadDevicesToSelect();  // <-- refresh aussi la liste déroulante update !
                showToast("Équipement ajouté avec succès !");
            })
            .catch(err=>{
                showToast("Erreur ajout équipement: " + (err.response?.data?.error || err.message), "danger");
            });
    }
});

document.getElementById('uploadForm').addEventListener('submit',e=>{
    e.preventDefault();
    const file=document.getElementById('fileInput').files[0];
    if(!file){
        showToast("Aucun fichier sélectionné", "warning");
        return;
    }
    const formData=new FormData();
    formData.append('file',file);
    axios.post('/api/upload',formData)
        .then(res=>{
            showToast("Upload OK !");
        })
        .catch(err=>{
            showToast("Erreur upload : " + (err.response?.data?.error || err.message), "danger");
        });
});

document.getElementById('updateBtn').addEventListener('click',()=>{
    const id=document.getElementById('deviceSelect').value;
    if(!id){
        showToast("Sélectionnez un équipement d'abord", "warning");
        return;
    }
    axios.post(`/api/update/${id}`).then(()=>{
        window.open(`/console/${id}`, '_blank');
    });
});

document.addEventListener('DOMContentLoaded',()=>{
    loadInventory();
    loadDevicesToSelect();
});
</script>
</body>
</html>
